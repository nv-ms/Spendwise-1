<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit</title>
    <style>
        *{
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            overflow: hidden;
            box-sizing: border-box;
        }
        body {
            background-color: white;
        }
        .head{
            display: flex;
            flex-direction: column-reverse;
            width: 100%;
            background-color: #007aff;
            color: white;
            padding: 10px;
        }
        .back{
            background-image: url('previous.png');
            background-repeat: no-repeat;
            height: 30px;
            width: 30px;
            background-size: cover;
            align-self: flex-start;
            padding: 5px;
        }
        .title{
            width: 100%;
            text-align: center;
        }
        .main{
            margin: 30px;
            padding: 20px;
            background-color: rgb(245, 245, 245);
            border: 1px solid rgb(94, 94, 94);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .statusDiv{
            color: red;
            text-align: center;
        }
        .Edit{
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        .transactionName{
            width: 100%;
            height:50px;
            padding: 10px;
            margin:  5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            background-color: white;
            background-image: url('tag.png');
            background-position: 10px 15px;
            background-repeat: no-repeat;
            padding-left: 40px;
        }
        .transactionAmount{
            width: 100%;
            height:50px;
            padding: 10px;
            margin:  5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            background-color: white;
            background-image: url('money.png');
            background-position: 10px 15px;
            background-repeat: no-repeat;
            padding-left: 40px;
        }
        .transactionFee{
            width: 100%;
            height:50px;
            padding: 10px;
            margin:  5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            background-color: white;
            background-image: url('money.png');
            background-position: 10px 15px;
            background-repeat: no-repeat;
            padding-left: 40px;
        }
        .transactionDescription{
            width: 100%;
            height:50px;
            padding: 10px;
            margin:  5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            background-color: white;
            background-image: url('description.png');
            background-position: 10px 10px;
            background-size: 30px;
            background-repeat: no-repeat;
            padding-left: 40px;
        }
        .tAttachment{
            width: 90%;
            margin: 5px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            border: none;
            border-radius: 5px;
        }
        .attachmentBtn{
            display: flex;
            justify-content: center;
            width: 100%;
        }
        .fileBtn{
            width: 30px;
            height: 30px;
            border: none;
            background-image: url('upload.png');
            background-size: cover;
            background-color: rgb(245, 245, 245);
            display: block;
        }
        .iconsDiv{
            display: flex;
            flex-direction: column;
            width: 100%;
            display: none;
        }
        .funBtn{
            display: flex;
            width: 100%;
            justify-content: center;
            height: 50px;
            align-items: center;
        }
        .iconBtn{
            border: none;
            width: 30px;
            height: 30px;
            margin: 2px;
            background-color:  rgb(245, 245, 245);
        }
        #cancelIcon{
            background-image: url('cancel.png');
            background-size: 20px;
            background-repeat: no-repeat;
            align-self: flex-end;
        }
        #cameraIcon{
            background-image: url(camera.png);
            background-size: 30px;
            background-repeat: no-repeat;
            margin: 5px;
        }
        #galleryIcon{
            background-image: url(image.png);
            background-size: 30px;
            background-repeat: no-repeat;
            margin: 5px;
        }
        .imgContainer{
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .image{
            border-radius: 5px;
            margin: 2px;
            width: 50px;
            height: 50px;
            object-fit: cover;
        }
        .clearBtn{
            display: none;
            border: none;
            background-image: url('cancel.png');
            background-size: cover;
            width: 20px;
            height: 20px;
            background-color:  rgb(245, 245, 245);
        }
        .removeBtn{
            background-color: rgb(255, 68, 68);
            border: none;
            width: 160px;
            height: 40px;
            border-radius: 5px;
            color: rgb(245, 245, 245);
            font-size: 15px;
            align-self: center;
            display: none;
        }
        .footer{
            display: flex;
            justify-content: center;
        }
        .addTbtn{
            border: none;
            background-color: #007aff;
            color: white;
            height: 50px;
            width: 200px;
            border-radius: 10px;
            font-size: 20px;

        }
        .spinner{
            display:none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }
        .loader {
            top: 50%;
            left: 50%;
            font-size: 10px;
            width: 1em;
            height: 1em;
            border-radius: 50%;
            position: fixed;
            text-indent: -9999em;
            animation: mulShdSpin .7s infinite ease;
            transform: translateZ(0);
            z-index: 2000;
        }
        @keyframes mulShdSpin {
            0%,
            100% {
                box-shadow: 0em -2.6em 0em 0em #ffffff, 1.8em -1.8em 0 0em rgba(255,255,255, 0.2), 2.5em 0em 0 0em rgba(255,255,255, 0.2), 1.75em 1.75em 0 0em rgba(255,255,255, 0.2), 0em 2.5em 0 0em rgba(255,255,255, 0.2), -1.8em 1.8em 0 0em rgba(255,255,255, 0.2), -2.6em 0em 0 0em rgba(255,255,255, 0.5), -1.8em -1.8em 0 0em rgba(255,255,255, 0.7);
            }
            12.5% {
                box-shadow: 0em -2.6em 0em 0em rgba(255,255,255, 0.7), 1.8em -1.8em 0 0em #ffffff, 2.5em 0em 0 0em rgba(255,255,255, 0.2), 1.75em 1.75em 0 0em rgba(255,255,255, 0.2), 0em 2.5em 0 0em rgba(255,255,255, 0.2), -1.8em 1.8em 0 0em rgba(255,255,255, 0.2), -2.6em 0em 0 0em rgba(255,255,255, 0.2), -1.8em -1.8em 0 0em rgba(255,255,255, 0.5);
            }
            25% {
                box-shadow: 0em -2.6em 0em 0em rgba(255,255,255, 0.5), 1.8em -1.8em 0 0em rgba(255,255,255, 0.7), 2.5em 0em 0 0em #ffffff, 1.75em 1.75em 0 0em rgba(255,255,255, 0.2), 0em 2.5em 0 0em rgba(255,255,255, 0.2), -1.8em 1.8em 0 0em rgba(255,255,255, 0.2), -2.6em 0em 0 0em rgba(255,255,255, 0.2), -1.8em -1.8em 0 0em rgba(255,255,255, 0.2);
            }
            37.5% {
                box-shadow: 0em -2.6em 0em 0em rgba(255,255,255, 0.2), 1.8em -1.8em 0 0em rgba(255,255,255, 0.5), 2.5em 0em 0 0em rgba(255,255,255, 0.7), 1.75em 1.75em 0 0em #ffffff, 0em 2.5em 0 0em rgba(255,255,255, 0.2), -1.8em 1.8em 0 0em rgba(255,255,255, 0.2), -2.6em 0em 0 0em rgba(255,255,255, 0.2), -1.8em -1.8em 0 0em rgba(255,255,255, 0.2);
            }
            50% {
                box-shadow: 0em -2.6em 0em 0em rgba(255,255,255, 0.2), 1.8em -1.8em 0 0em rgba(255,255,255, 0.2), 2.5em 0em 0 0em rgba(255,255,255, 0.5), 1.75em 1.75em 0 0em rgba(255,255,255, 0.7), 0em 2.5em 0 0em #ffffff, -1.8em 1.8em 0 0em rgba(255,255,255, 0.2), -2.6em 0em 0 0em rgba(255,255,255, 0.2), -1.8em -1.8em 0 0em rgba(255,255,255, 0.2);
            }
            62.5% {
                box-shadow: 0em -2.6em 0em 0em rgba(255,255,255, 0.2), 1.8em -1.8em 0 0em rgba(255,255,255, 0.2), 2.5em 0em 0 0em rgba(255,255,255, 0.2), 1.75em 1.75em 0 0em rgba(255,255,255, 0.5), 0em 2.5em 0 0em rgba(255,255,255, 0.7), -1.8em 1.8em 0 0em #ffffff, -2.6em 0em 0 0em rgba(255,255,255, 0.2), -1.8em -1.8em 0 0em rgba(255,255,255, 0.2);
            }
            75% {
                box-shadow: 0em -2.6em 0em 0em rgba(255,255,255, 0.2), 1.8em -1.8em 0 0em rgba(255,255,255, 0.2), 2.5em 0em 0 0em rgba(255,255,255, 0.2), 1.75em 1.75em 0 0em rgba(255,255,255, 0.2), 0em 2.5em 0 0em rgba(255,255,255, 0.5), -1.8em 1.8em 0 0em rgba(255,255,255, 0.7), -2.6em 0em 0 0em #ffffff, -1.8em -1.8em 0 0em rgba(255,255,255, 0.2);
            }
            87.5% {
                box-shadow: 0em -2.6em 0em 0em rgba(255,255,255, 0.2), 1.8em -1.8em 0 0em rgba(255,255,255, 0.2), 2.5em 0em 0 0em rgba(255,255,255, 0.2), 1.75em 1.75em 0 0em rgba(255,255,255, 0.2), 0em 2.5em 0 0em rgba(255,255,255, 0.2), -1.8em 1.8em 0 0em rgba(255,255,255, 0.5), -2.6em 0em 0 0em rgba(255,255,255, 0.7), -1.8em -1.8em 0 0em #ffffff;
            }
        }
    </style>
</head>
<body>
    <div class="spinner" id="spinner">
        <div class="loader"></div>
    </div>
    <div class="head">
        <div class="back" onclick="window.location.href=`transactionDetails.html?userId=${encodeURIComponent(userId)}&transactionId=${encodeURIComponent(transactionId)}`"></div>
        <div class="title"><h1>Edit Transaction</h1></div>
    </div>
    <div class="main">
        <div class="statusDiv" id="statusDiv"></div>
        <div class="Edit">
            <label for="transactionName">Title</label>
            <input type="text" name="transactionName" class="transactionName" id="transactionName">
        </div>
        <div class="Edit">
            <label for="transactionAmount">Amount</label>
            <input type="number" name="transactionAmount" id="transactionAmount" class="transactionAmount">
        </div>
        <div class="Edit">
            <label for="transactionFee">Transaction Cost</label>
            <input type="number" name="transactionFee" id="transactionFee" class="transactionFee">
        </div>
        <div class="Edit">
            <div class="Edit">
                <label for="transactionDescription">Description</label>
                <input type="text" name="tansactionDescription" id="transactionDescription" class="transactionDescription">
            </div>
        </div>
        <div class="tAttachment">
            <div class="attachmentBtn">
                <button type="button" onclick="toggleIcons()" class="fileBtn" id="uploadBtn"></button>
                <button type="button" onclick="removeImg();" class="removeBtn" id="removeBtn">Remove Image</button>
                <div class="iconsDiv" id="iconsDiv">                    
                    <button type="button" class="iconBtn" id="cancelIcon" onclick="toggleIcons();"></button>
                    <div class="funBtn">
                        <button type="button" class="iconBtn" id="cameraIcon" onclick="openFilePicker('camera')"></button>
                        <button type="button" class="iconBtn" id="galleryIcon" onclick="openFilePicker('gallery')"></button>
                    </div>
                </div>
                <button type="button" onclick="clearSelection();" class="clearBtn" id="clearBtn"></button>
            </div>
            <div class="imgContainer" id="imageContainer"></div>
        </div>
    </div>
    <div class="footer">
        <div class="update">
            <button type="button" id="submitButton" class="addTbtn" onclick="updateTransaction();">Update Transaction</button>
        </div>
    </div>
    <script>
        function getUrlParameter(name) {
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(window.location.href);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }
        const toggleElements = (action, element) => {
            element.style.display = action === "open" ? "block" : "none";
        };
        const userId = getUrlParameter("userId");
        const transactionId = getUrlParameter("transactionId");
        const transaction = JSON.parse(javascriptBridge.getTransactionById(transactionId));
        const removeImgBtn = document.getElementById('removeBtn');
        const statusDiv = document.getElementById('statusDiv');
        const container = document.getElementById("imageContainer");
        const uploadBtn = document.getElementById("uploadBtn");
        const spinner = document.getElementById('spinner');
        let isImageremovable = false;
        var imageOption;

        const toggleIcons =()=>{
            if (window.getComputedStyle) {
                const computedStyle = window.getComputedStyle(iconsDiv);
                const displayPropertyValue = computedStyle.getPropertyValue('display');
                if (displayPropertyValue === 'none') {
                    toggleElements('open', iconsDiv);
                    toggleElements('close', uploadBtn);
                }else if(displayPropertyValue === 'block'){
                    toggleElements('open', uploadBtn);
                    toggleElements('close', iconsDiv);
                }
            }       
        }
        

        if(transaction.imageName == "null"){
            toggleElements('close', removeImgBtn);
            toggleElements('open', uploadBtn);
        }else{
            toggleElements('open', removeImgBtn);
            toggleElements('close', uploadBtn);
        }
       
        const updateTransaction = () => {
            let title, amount, fee,description, imagePath, process, reference;

            const newTitle = document.getElementById("transactionName").value;
            const newAmount = parseFloat(document.getElementById("transactionAmount").value);
            const newFee = parseFloat(document.getElementById('transactionFee').value);
            const newDescription = document.getElementById("transactionDescription").value;

            const oldTitle = transaction.transactionTitle;
            const oldAmount = transaction.amount;
            const oldFee = transaction.transactionCost;
            const oldDescription = transaction.description;
            reference = transaction.refDescription;

            imageName = transaction.imageName;
            
            if (imagePath == undefined){
                imagePath = "notDefined";
            }

            title = newTitle || oldTitle;
            amount = isNaN(newAmount) ? oldAmount : newAmount;
            fee = isNaN(newFee) ? oldFee : newFee;
            description = newDescription || oldDescription;

            if(isImageremovable){
                imageName = "null";
                process = "delete";
            }else if(container.children.length == 1){
                process = "update";
                if(imageOption == "gallery"){
                    imagePath = javascriptBridge.getImagePath();
                }else if(imageOption == "camera"){
                    imagePath = javascriptBridge.getImageTempPath();
                }
            }else{
                process = "preserve"
            }

            if(container.children.length <= 0 && imageName == "null"){
                imagePath = "notDefined";
            }
            spinner.style.display = 'block';
            setTimeout(()=>{
                if (javascriptBridge.updateTransaction(transactionId, title, amount, fee, description, reference ,process,imagePath, imageName )) {
                    spinner.style.display = 'none';
                    window.location.href = `transactionDetails.html?userId=${encodeURIComponent(userId)}&transactionId=${encodeURIComponent(transactionId)}`;
                } else {
                    statusDiv.textContent = "Failed, try again later";
                }
            },1000);
            
        }
        const removeImg = ()=>{
            isImageremovable = true;
            toggleElements('close', removeImgBtn);;
            toggleElements('open', uploadBtn);
        }
        const openFilePicker = (option)=>{
            imageOption = option;
            javascriptBridge.openFilePicker(option);
        }
        function handleSelectedFile(filePath) {
            var img = document.createElement("img");
            img.classList.add('image')
            img.src = filePath;

            const container = document.getElementById("imageContainer");
            container.appendChild(img);
            toggleElements('open', clearBtn);
            toggleElements('close', iconsDiv);
            toggleElements('close', removeImgBtn);
        }
        const clearSelection =()=>{
            const container = document.getElementById("imageContainer");
            container.innerHTML = " ";
            toggleElements('close', clearBtn);
            toggleElements('open', iconsDiv);
            toggleElements('close', removeImgBtn);
        }
        const btnPressed = () => {
            window.location.href = `transactionDetails.html?userId=${encodeURIComponent(userId)}&transactionId=${encodeURIComponent(transactionId)}`
        }
    </script>
</body>
</html>